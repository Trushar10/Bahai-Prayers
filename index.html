<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, user-scalable=no"
		/>
		<title>Bahá'í Prayers</title>
		<meta
			name="description"
			content="Modern Bahá'í Prayers app with elegant design and native app experience"
		/>

		<!-- PWA Meta Tags -->
		<meta name="theme-color" content="#667eea" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="default" />
		<meta name="apple-mobile-web-app-title" content="Prayers" />

		<!-- Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>

		<style>
			/* CSS Custom Properties for Theme System */
			:root {
				/* Light Theme */
				--bg-primary: #ffffff;
				--bg-secondary: #f8fafc;
				--bg-tertiary: #f1f5f9;
				--text-primary: #0f172a;
				--text-secondary: #475569;
				--text-tertiary: #64748b;
				--accent-primary: #667eea;
				--accent-secondary: #764ba2;
				--border-light: #e2e8f0;
				--border-medium: #cbd5e1;
				--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
				--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
				--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
				--shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
				--radius-sm: 8px;
				--radius-md: 12px;
				--radius-lg: 16px;
				--radius-xl: 20px;
			}

			[data-theme='dark'] {
				/* Dark Theme */
				--bg-primary: #0f172a;
				--bg-secondary: #1e293b;
				--bg-tertiary: #334155;
				--text-primary: #f8fafc;
				--text-secondary: #cbd5e1;
				--text-tertiary: #94a3b8;
				--accent-primary: #818cf8;
				--accent-secondary: #a78bfa;
				--border-light: #334155;
				--border-medium: #475569;
				--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.2);
				--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3);
				--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4);
				--shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.5);
			}

			/* Base Styles */
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			html {
				-webkit-text-size-adjust: 100%;
				-webkit-tap-highlight-color: transparent;
			}

			body {
				font-family: 'Inter', -apple-system, BlinkMacSystemFont,
					'Segoe UI', system-ui, sans-serif;
				background: var(--bg-secondary);
				color: var(--text-primary);
				line-height: 1.6;
				font-feature-settings: 'cv11', 'ss01';
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
				overflow-x: hidden;
				transition: background-color 0.3s ease, color 0.3s ease;
			}

			/* App Container */
			.app {
				max-width: 430px;
				margin: 20px auto;
				min-height: calc(100vh - 40px);
				background: var(--bg-primary);
				box-shadow: var(--shadow-xl);
				position: relative;
				overflow: hidden;
				border-radius: var(--radius-xl);
			}

			/* Desktop styles */
			@media (min-width: 768px) {
				.app {
					height: calc(100vh - 40px);
					margin: 20px auto;
					min-height: calc(100vh - 40px);
					overflow-y: auto;
					border-radius: var(--radius-xl);
				}
			}

			/* Hide scrollbar while keeping scroll functionality */
			.app {
				/* Hide scrollbar for WebKit browsers */
				-ms-overflow-style: none; /* Internet Explorer 10+ */
				scrollbar-width: none; /* Firefox */
			}

			.app::-webkit-scrollbar {
				display: none; /* Safari and Chrome */
			}

			/* Navigation Header */
			.nav-header {
				background: var(--bg-primary);
				padding: 16px 20px;
				border-bottom: 1px solid var(--border-light);
				position: sticky;
				top: 0;
				z-index: 100;
				backdrop-filter: blur(20px);
				-webkit-backdrop-filter: blur(20px);
			}

			.nav-content {
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.nav-left {
				display: flex;
				align-items: center;
				gap: 12px;
			}

			.back-btn {
				background: none;
				border: none;
				color: var(--accent-primary);
				font-size: 16px;
				font-weight: 500;
				display: flex;
				align-items: center;
				gap: 4px;
				cursor: pointer;
				padding: 8px;
				border-radius: var(--radius-sm);
				transition: all 0.2s ease;
				opacity: 0;
				transform: translateX(-10px);
			}

			.back-btn.visible {
				opacity: 1;
				transform: translateX(0);
			}

			.back-btn:active {
				transform: scale(0.95);
				background: var(--bg-tertiary);
			}

			.app-title {
				font-size: 20px;
				font-weight: 700;
				color: var(--text-primary);
				letter-spacing: -0.02em;
			}

			.nav-right {
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.control-btn {
				background: var(--bg-tertiary);
				border: none;
				width: 36px;
				height: 36px;
				border-radius: var(--radius-sm);
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				transition: all 0.2s ease;
				color: var(--text-secondary);
			}

			.control-btn:active {
				transform: scale(0.95);
				background: var(--border-medium);
			}

			/* Language Selector */
			.language-selector {
				position: relative;
			}

			.language-menu {
				position: absolute;
				top: 100%;
				right: 0;
				background: var(--bg-primary);
				border: 1px solid var(--border-light);
				border-radius: var(--radius-md);
				box-shadow: var(--shadow-lg);
				min-width: 120px;
				z-index: 200;
				opacity: 0;
				transform: translateY(-10px) scale(0.95);
				pointer-events: none;
				transition: all 0.2s ease;
				margin-top: 8px;
			}

			.language-menu.open {
				opacity: 1;
				transform: translateY(0) scale(1);
				pointer-events: all;
			}

			.language-option {
				padding: 12px 16px;
				cursor: pointer;
				transition: background 0.2s ease;
				font-weight: 500;
				color: var(--text-secondary);
			}

			.language-option:hover,
			.language-option.active {
				background: var(--bg-tertiary);
				color: var(--text-primary);
			}

			.language-option:first-child {
				border-radius: var(--radius-md) var(--radius-md) 0 0;
			}

			.language-option:last-child {
				border-radius: 0 0 var(--radius-md) var(--radius-md);
			}

			/* Main Content */
			.main-content {
				position: relative;
				min-height: calc(100vh - 120px);
				overflow: hidden; /* Ensure clean stack transitions */
			}

			.page-container {
				display: flex;
				width: 200%;
				height: 100%;
				position: relative;
				transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
			}

			/* Stack-based navigation states */
			.page-container.push-right {
				transform: translateX(-50%);
			}

			.page-container.pop-left {
				transform: translateX(0%);
			}

			/* Legacy support */
			.page-container.slide-left {
				transform: translateX(-50%);
			}
			.page {
				width: 50%;
				flex-shrink: 0;
				overflow-y: auto;
				scroll-behavior: smooth;
			}

			/* Home Page */
			.home-page {
				padding: 24px 20px;
			}

			.welcome-section {
				text-align: center;
				margin-bottom: 32px;
			}

			.welcome-title {
				font-size: 28px;
				font-weight: 700;
				color: var(--text-primary);
				margin-bottom: 8px;
				letter-spacing: -0.02em;
			}

			.welcome-subtitle {
				font-size: 16px;
				color: var(--text-secondary);
				font-weight: 400;
			}

			.prayer-section {
				margin-bottom: 32px;
			}

			.section-header {
				display: flex;
				align-items: center;
				margin-bottom: 16px;
				padding: 0 4px;
			}

			.section-title {
				font-size: 18px;
				font-weight: 600;
				color: var(--text-primary);
				letter-spacing: -0.01em;
			}

			.section-count {
				background: var(--bg-tertiary);
				color: var(--text-secondary);
				font-size: 12px;
				font-weight: 500;
				padding: 4px 8px;
				border-radius: 12px;
				margin-left: 12px;
			}

			.prayer-grid {
				display: grid;
				gap: 12px;
			}

			.prayer-card {
				background: var(--bg-primary);
				border: 1px solid var(--border-light);
				border-radius: var(--radius-lg);
				padding: 20px;
				cursor: pointer;
				transition: all 0.3s ease;
				position: relative;
				overflow: hidden;
			}

			.prayer-card::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				height: 3px;
				background: linear-gradient(
					90deg,
					var(--accent-primary),
					var(--accent-secondary)
				);
				transform: scaleX(0);
				transition: transform 0.3s ease;
			}

			.prayer-card:hover {
				transform: translateY(-2px);
				box-shadow: var(--shadow-lg);
				border-color: var(--border-medium);
			}

			.prayer-card:hover::before {
				transform: scaleX(1);
			}

			.prayer-card:active {
				transform: translateY(0);
			}

			.prayer-title {
				font-size: 16px;
				font-weight: 500;
				color: var(--text-primary);
				line-height: 1.4;
				margin-bottom: 8px;
			}

			.prayer-meta {
				display: flex;
				align-items: center;
				gap: 8px;
				color: var(--text-tertiary);
				font-size: 14px;
			}

			.prayer-icon {
				width: 16px;
				height: 16px;
				opacity: 0.7;
			}

			/* Detail Page */
			.detail-page {
				padding: 24px 20px;
				background: var(--bg-secondary);
				height: 100%;
				overflow-y: auto;
				scroll-behavior: auto; /* Disable smooth scrolling for instant reset */
			}

			/* Force scroll reset when detail page becomes active */
			.page-container.push-right .detail-page {
				scroll-behavior: auto;
			}

			/* Ensure proper scroll reset for detail page */
			.detail-page {
				scroll-snap-type: none;
				overscroll-behavior: contain;
			}
			.prayer-detail {
				background: var(--bg-primary);
				border-radius: var(--radius-xl);
				overflow: hidden;
				box-shadow: var(--shadow-md);
			}

			.prayer-header {
				padding: 24px;
				background: linear-gradient(
					135deg,
					var(--accent-primary),
					var(--accent-secondary)
				);
				color: white;
				text-align: center;
			}

			.prayer-detail-title {
				font-size: 24px;
				font-weight: 700;
				margin-bottom: 8px;
				letter-spacing: -0.02em;
			}

			.prayer-detail-meta {
				font-size: 14px;
				opacity: 0.9;
			}

			.prayer-content {
				padding: 32px 24px;
				line-height: 1.8;
			}

			.prayer-text {
				font-size: 18px;
				color: var(--text-primary);
				font-weight: 400;
				text-align: justify;
				margin-bottom: 24px;
			}

			.prayer-text p {
				margin-bottom: 20px;
			}

			.prayer-text p:last-child {
				margin-bottom: 0;
			}

			/* Action Buttons */
			.action-buttons {
				display: flex;
				gap: 12px;
				padding: 0 24px 24px;
			}

			.action-btn {
				flex: 1;
				background: var(--bg-tertiary);
				border: none;
				padding: 12px 16px;
				border-radius: var(--radius-md);
				font-weight: 500;
				cursor: pointer;
				transition: all 0.2s ease;
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 8px;
				color: var(--text-secondary);
			}

			.action-btn:active {
				transform: scale(0.95);
			}

			.action-btn.primary {
				background: var(--accent-primary);
				color: white;
			}

			/* Feedback Section */
			.feedback-section {
				margin-top: 32px;
				text-align: center;
			}

			.feedback-link {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				background: var(--bg-primary);
				color: var(--accent-primary);
				text-decoration: none;
				padding: 12px 20px;
				border-radius: var(--radius-lg);
				border: 1px solid var(--border-light);
				font-weight: 500;
				transition: all 0.2s ease;
			}

			.feedback-link:hover {
				transform: translateY(-1px);
				box-shadow: var(--shadow-md);
			}

			/* Loading State */
			.loading {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				height: 60vh;
				gap: 16px;
			}

			.loading-spinner {
				width: 32px;
				height: 32px;
				border: 3px solid var(--border-light);
				border-top: 3px solid var(--accent-primary);
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.loading-text {
				color: var(--text-secondary);
				font-weight: 500;
			}

			/* Install Button */
			.install-prompt {
				position: fixed;
				bottom: 20px;
				right: 20px;
				background: var(--accent-primary);
				color: white;
				border: none;
				width: 56px;
				height: 56px;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				box-shadow: var(--shadow-lg);
				transition: all 0.3s ease;
				z-index: 150;
				opacity: 0;
				transform: scale(0.8);
			}

			.install-prompt.visible {
				opacity: 1;
				transform: scale(1);
			}

			.install-prompt:active {
				transform: scale(0.9);
			}

			/* Bottom Safe Area */
			.bottom-safe-area {
				height: env(safe-area-inset-bottom, 20px);
				background: var(--bg-primary);
			}

			/* Animations */
			@keyframes fadeInUp {
				from {
					opacity: 0;
					transform: translateY(20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.fade-in-up {
				animation: fadeInUp 0.5s ease forwards;
			}

			/* Responsive Adjustments */
			@media (max-width: 375px) {
				.prayer-card {
					padding: 16px;
				}

				.prayer-content {
					padding: 24px 20px;
				}

				.prayer-text {
					font-size: 16px;
				}
			}

			/* High contrast mode support */
			@media (prefers-contrast: high) {
				:root {
					--border-light: #000000;
					--border-medium: #000000;
				}

				[data-theme='dark'] {
					--border-light: #ffffff;
					--border-medium: #ffffff;
				}
			}

			/* Reduced motion support */
			@media (prefers-reduced-motion: reduce) {
				* {
					animation-duration: 0.01ms !important;
					animation-iteration-count: 1 !important;
					transition-duration: 0.01ms !important;
				}
			}
		</style>
	</head>
	<body>
		<div class="app">
			<!-- Navigation Header -->
			<div class="nav-header">
				<div class="nav-content">
					<div class="nav-left">
						<button class="back-btn" id="backBtn">
							<svg
								width="16"
								height="16"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
							>
								<polyline points="15,18 9,12 15,6"></polyline>
							</svg>
							Back
						</button>
					</div>
					<div class="nav-right">
						<div class="language-selector">
							<button class="control-btn" id="languageBtn">
								<svg
									width="20"
									height="20"
									viewBox="0 0 24 24"
									fill="currentColor"
								>
									<path
										d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"
									/>
								</svg>
							</button>
							<div class="language-menu" id="languageMenu">
								<div
									class="language-option active"
									data-lang="en"
								>
									English
								</div>
								<div class="language-option" data-lang="hi">
									हिन्दी
								</div>
								<div class="language-option" data-lang="gu">
									ગુજરાતી
								</div>
							</div>
						</div>
						<button class="control-btn" id="themeBtn">
							<svg
								class="theme-icon-light"
								width="20"
								height="20"
								viewBox="0 0 24 24"
								fill="currentColor"
							>
								<path
									d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
								/>
							</svg>
							<svg
								class="theme-icon-dark"
								width="20"
								height="20"
								viewBox="0 0 24 24"
								fill="currentColor"
								style="display: none"
							>
								<circle cx="12" cy="12" r="5" />
								<line x1="12" y1="1" x2="12" y2="3" />
								<line x1="12" y1="21" x2="12" y2="23" />
								<line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
								<line
									x1="18.36"
									y1="18.36"
									x2="19.78"
									y2="19.78"
								/>
								<line x1="1" y1="12" x2="3" y2="12" />
								<line x1="21" y1="12" x2="23" y2="12" />
								<line
									x1="4.22"
									y1="19.78"
									x2="5.64"
									y2="18.36"
								/>
								<line
									x1="18.36"
									y1="5.64"
									x2="19.78"
									y2="4.22"
								/>
							</svg>
						</button>
					</div>
				</div>
			</div>

			<!-- Main Content -->
			<div class="main-content">
				<div class="page-container" id="pageContainer">
					<!-- Home Page -->
					<div class="page">
						<div class="home-page" id="homePage">
							<!-- Loading State -->
							<div class="loading" id="loadingState">
								<div class="loading-spinner"></div>
								<div class="loading-text">
									Loading prayers...
								</div>
							</div>

							<!-- Content will be loaded here -->
							<div id="homeContent" style="display: none">
								<div class="welcome-section">
									<h1 class="welcome-title">
										Bahá'í Prayers
									</h1>
									<p class="welcome-subtitle">
										Find peace and guidance through prayer
									</p>
								</div>

								<div id="prayerSections">
									<!-- Prayer sections will be dynamically loaded -->
								</div>

								<div class="feedback-section">
									<a
										href="https://forms.gle/sG99p4CB78WPX8y46"
										target="_blank"
										class="feedback-link"
									>
										<span>📝</span>
										Share Your Feedback
									</a>
								</div>
							</div>
						</div>
					</div>

					<!-- Detail Page -->
					<div class="page prayer-view-page">
						<div class="detail-page" id="detailPage">
							<div class="prayer-detail" id="prayerDetail">
								<!-- Prayer detail content will be loaded here -->
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Install Button -->
			<button class="install-prompt" id="installBtn">
				<svg
					width="24"
					height="24"
					viewBox="0 0 24 24"
					fill="currentColor"
				>
					<path
						d="M12 2L3 9h3v9h12v-9h3L12 2zm0 3.5L16.5 9H15v7H9V9H7.5L12 5.5z"
					/>
				</svg>
			</button>

			<!-- Bottom Safe Area -->
			<div class="bottom-safe-area"></div>
		</div>

		<script>
			// App State
			let currentLanguage = 'en';
			let currentTheme = 'light';
			let prayers = [];
			let currentPrayer = null;
			let groupedPrayers = {};
			let isDetailView = false;
			let deferredPrompt = null;
			let homePageScrollPosition = 0; // Track home page scroll position

			// Navigation Stack Implementation
			let navigationStack = [];
			let isNavigating = false;

			// Mock prayer data (replace with actual API calls)
			const mockPrayers = {
				en: {
					obligatory: [
						{
							id: '1',
							title: 'Short Obligatory Prayer',
							slug: 'short-obligatory-prayer',
							content:
								'I bear witness, O my God, that Thou hast created me to know Thee and to worship Thee. I testify, at this moment, to my powerlessness and to Thy might, to my poverty and to Thy wealth. There is none other God but Thee, the Help in Peril, the Self-Subsisting.',
						},
						{
							id: '2',
							title: 'Medium Obligatory Prayer',
							slug: 'medium-obligatory-prayer',
							content:
								'Whoso wisheth to pray, let him wash his hands, and while he washeth, let him say: Strengthen my hand, O my God, that it may take hold of Thy Book with such steadfastness that the hosts of the world shall have no power over it...',
						},
					],
					devotional: [
						{
							id: '3',
							title: 'Prayer for Spiritual Growth',
							slug: 'prayer-spiritual-growth',
							content:
								'O God! Refresh and gladden my spirit. Purify my heart. Illumine my powers. I lay all my affairs in Thy hand. Thou art my Guide and my Refuge. I will no longer be sorrowful and grieved; I will be a happy and joyful being...',
						},
						{
							id: '4',
							title: 'Prayer for Guidance',
							slug: 'prayer-guidance',
							content:
								'O Thou kind Lord! I am a little child, exalt me by admitting me to Thy Kingdom. I am earthly, make me heavenly; I am of the world below, let me belong to the realm above...',
						},
					],
					healing: [
						{
							id: '5',
							title: 'Prayer for Healing',
							slug: 'prayer-healing',
							content:
								'Thy name is my healing, O my God, and remembrance of Thee is my remedy. Nearness to Thee is my hope, and love for Thee is my companion. Thy mercy to me is my healing and my succor in both this world and the world to come...',
						},
					],
				},
			};

			// Initialize app
			document.addEventListener('DOMContentLoaded', function () {
				initializeApp();
				setupEventListeners();
				loadPrayers();
			});

			function initializeApp() {
				// Initialize navigation stack
				navigationStack = [];
				isNavigating = false;
				updateBackButtonVisibility();

				// Load saved theme
				const savedTheme =
					localStorage.getItem('theme') ||
					(window.matchMedia('(prefers-color-scheme: dark)').matches
						? 'dark'
						: 'light');
				setTheme(savedTheme); // Load saved language
				const savedLanguage = localStorage.getItem('language') || 'en';
				setLanguage(savedLanguage);

				// PWA install prompt
				window.addEventListener('beforeinstallprompt', (e) => {
					e.preventDefault();
					deferredPrompt = e;
					showInstallButton();
				});

				// Check if already installed
				if (window.matchMedia('(display-mode: standalone)').matches) {
					hideInstallButton();
				}
			}

			function setupEventListeners() {
				// Back button
				document
					.getElementById('backBtn')
					.addEventListener('click', goBack);

				// Theme toggle
				document
					.getElementById('themeBtn')
					.addEventListener('click', toggleTheme);

				// Language toggle
				document
					.getElementById('languageBtn')
					.addEventListener('click', toggleLanguageMenu);

				// Language options
				document
					.querySelectorAll('.language-option')
					.forEach((option) => {
						option.addEventListener('click', (e) => {
							const lang = e.target.dataset.lang;
							setLanguage(lang);
							closeLanguageMenu();
						});
					});

				// Install button
				document
					.getElementById('installBtn')
					.addEventListener('click', installApp);

				// Close language menu when clicking outside
				document.addEventListener('click', (e) => {
					if (!e.target.closest('.language-selector')) {
						closeLanguageMenu();
					}
				});

				// Browser history handling
				window.addEventListener('popstate', handlePopState);
			}

			function loadPrayers() {
				// Simulate API loading
				setTimeout(() => {
					prayers = mockPrayers[currentLanguage] || mockPrayers.en;
					groupedPrayers = prayers;
					renderHomePage();
					hideLoading();
				}, 1000);
			}

			function renderHomePage() {
				const sectionsContainer =
					document.getElementById('prayerSections');
				sectionsContainer.innerHTML = '';

				Object.entries(groupedPrayers).forEach(
					([category, categoryPrayers]) => {
						const section = document.createElement('div');
						section.className = 'prayer-section fade-in-up';

						section.innerHTML = `
                    <div class="section-header">
                        <h2 class="section-title">${formatCategoryName(
							category
						)}</h2>
                        <span class="section-count">${
							categoryPrayers.length
						}</span>
                    </div>
                    <div class="prayer-grid">
                        ${categoryPrayers
							.map(
								(prayer) => `
                            <div class="prayer-card" onclick="openPrayer('${prayer.slug}')">
                                <h3 class="prayer-title">${prayer.title}</h3>
                                <div class="prayer-meta">
                                    <svg class="prayer-icon" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                    <span>Available</span>
                                </div>
                            </div>
                        `
							)
							.join('')}
                    </div>
                `;

						sectionsContainer.appendChild(section);
					}
				);
			}

			// Stack Navigation Functions
			function pushView(viewData) {
				if (isNavigating) return false;

				navigationStack.push(viewData);
				isNavigating = true;

				const pageContainer = document.getElementById('pageContainer');
				const detailPage = document.getElementById('detailPage');

				// Ensure detail page is at top before transition starts
				detailPage.style.scrollBehavior = 'auto';
				detailPage.scrollTop = 0;

				// Start the slide transition
				pageContainer.classList.add('push-right');

				// Update back button visibility
				updateBackButtonVisibility();

				// Additional resets during transition to ensure top positioning
				setTimeout(() => {
					detailPage.scrollTop = 0;
				}, 50);

				// Reset navigation flag after transition
				setTimeout(() => {
					detailPage.scrollTop = 0; // Final safety reset
					detailPage.style.scrollBehavior = 'smooth';
					isNavigating = false;
				}, 250);
				return true;
			}
			function popView() {
				if (isNavigating || navigationStack.length === 0) return false;

				isNavigating = true;
				const poppedView = navigationStack.pop();

				const pageContainer = document.getElementById('pageContainer');
				pageContainer.classList.remove('push-right');

				// Update back button visibility
				updateBackButtonVisibility();

				// Restore homepage scroll position after transition
				setTimeout(() => {
					if (navigationStack.length === 0) {
						// Back to home - restore saved scroll position
						const homePage = document.getElementById('homePage');
						homePage.scrollTop = homePageScrollPosition;
					}
					isNavigating = false;
				}, 250);

				return poppedView;
			}

			function updateBackButtonVisibility() {
				const backBtn = document.getElementById('backBtn');
				if (navigationStack.length > 0) {
					backBtn.classList.add('visible');
				} else {
					backBtn.classList.remove('visible');
				}
			}

			function openPrayer(slug) {
				// Save current scroll position before navigating
				const homePage = document.getElementById('homePage');
				homePageScrollPosition = homePage.scrollTop;

				// Find prayer by slug
				let prayer = null;
				for (const category of Object.values(groupedPrayers)) {
					prayer = category.find((p) => p.slug === slug);
					if (prayer) break;
				}

				if (!prayer) return;

				currentPrayer = prayer;
				isDetailView = true;

				// Pre-render content
				renderPrayerDetail(prayer);

				// Ensure detail page starts at absolute top with aggressive reset
				const detailPage = document.getElementById('detailPage');
				detailPage.style.scrollBehavior = 'auto';
				detailPage.scrollTop = 0;

				// Force multiple reflows to ensure positioning
				detailPage.offsetHeight;
				detailPage.scrollTop = 0;
				requestAnimationFrame(() => {
					detailPage.scrollTop = 0;
				});

				// Use stack-based navigation
				const viewData = {
					type: 'prayer',
					slug: slug,
					prayer: prayer,
					scrollPosition: 0,
					homeScrollPosition: homePageScrollPosition,
				};

				// Start transition with content positioned correctly
				pushView(viewData); // Update URL without page reload
				history.pushState({ view: 'detail', slug }, '', `#${slug}`);
			}
			function renderPrayerDetail(prayer) {
				const detailContainer = document.getElementById('prayerDetail');
				const detailPage = document.getElementById('detailPage');

				// Reset scroll and disable smooth behavior during render
				detailPage.style.scrollBehavior = 'auto';
				detailPage.scrollTop = 0;

				detailContainer.innerHTML = `
                <div class="prayer-header">
                    <h1 class="prayer-detail-title">${prayer.title}</h1>
                    <div class="prayer-detail-meta">Bahá'í Prayer</div>
                </div>
                <div class="prayer-content">
                    <div class="prayer-text">
                        <p>${prayer.content}</p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn" onclick="sharePrayer()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                        Share
                    </button>
                    <button class="action-btn primary" onclick="copyPrayer()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                        Copy
                    </button>
                </div>
            `;

				// Multiple aggressive resets after content is rendered
				detailPage.scrollTop = 0;
				detailPage.offsetHeight; // Force reflow
				detailPage.scrollTop = 0;
			}
			function showDetailView() {
				isDetailView = true;
				document
					.getElementById('pageContainer')
					.classList.add('slide-left');
				document.getElementById('backBtn').classList.add('visible');

				// Ensure detail page starts from top
				const detailPage = document.getElementById('detailPage');
				detailPage.scrollTop = 0;
			}

			function goBack() {
				// Use stack-based navigation
				const poppedView = popView();

				if (poppedView) {
					// Clear current prayer
					currentPrayer = null;
					isDetailView = false;

					// Update browser history
					history.pushState({ view: 'home' }, '', '/');
				}
			}

			function hideDetailView() {
				isDetailView = false;
				document
					.getElementById('pageContainer')
					.classList.remove('slide-left');
				document.getElementById('backBtn').classList.remove('visible');
				currentPrayer = null;
			}
			function toggleTheme() {
				const newTheme = currentTheme === 'light' ? 'dark' : 'light';
				setTheme(newTheme);
			}

			function setTheme(theme) {
				currentTheme = theme;
				document.documentElement.setAttribute('data-theme', theme);
				localStorage.setItem('theme', theme);

				// Update theme button icon
				const lightIcon = document.querySelector('.theme-icon-light');
				const darkIcon = document.querySelector('.theme-icon-dark');

				if (theme === 'dark') {
					lightIcon.style.display = 'none';
					darkIcon.style.display = 'block';
				} else {
					lightIcon.style.display = 'block';
					darkIcon.style.display = 'none';
				}
			}

			function toggleLanguageMenu() {
				const menu = document.getElementById('languageMenu');
				menu.classList.toggle('open');
			}

			function closeLanguageMenu() {
				document
					.getElementById('languageMenu')
					.classList.remove('open');
			}

			function setLanguage(language) {
				currentLanguage = language;
				localStorage.setItem('language', language);

				// Update active language option
				document
					.querySelectorAll('.language-option')
					.forEach((option) => {
						option.classList.toggle(
							'active',
							option.dataset.lang === language
						);
					});

				// Reload prayers for new language
				showLoading();
				loadPrayers();
			}

			function formatCategoryName(category) {
				return category.charAt(0).toUpperCase() + category.slice(1);
			}

			function showLoading() {
				document.getElementById('loadingState').style.display = 'flex';
				document.getElementById('homeContent').style.display = 'none';
			}

			function hideLoading() {
				document.getElementById('loadingState').style.display = 'none';
				document.getElementById('homeContent').style.display = 'block';
			}

			function showInstallButton() {
				document.getElementById('installBtn').classList.add('visible');
			}

			function hideInstallButton() {
				document
					.getElementById('installBtn')
					.classList.remove('visible');
			}

			function installApp() {
				if (deferredPrompt) {
					deferredPrompt.prompt();
					deferredPrompt.userChoice.then((choiceResult) => {
						if (choiceResult.outcome === 'accepted') {
							hideInstallButton();
						}
						deferredPrompt = null;
					});
				}
			}

			function handlePopState(event) {
				if (event.state && event.state.view === 'detail') {
					// Handle direct navigation to prayer
					const slug = event.state.slug;
					openPrayer(slug);
				} else {
					// Handle browser back button - sync with navigation stack
					if (navigationStack.length > 0) {
						goBack();
					}
				}
			}
			function sharePrayer() {
				if (navigator.share && currentPrayer) {
					navigator.share({
						title: currentPrayer.title,
						text: currentPrayer.content,
						url: window.location.href,
					});
				} else {
					copyPrayer();
				}
			}

			function copyPrayer() {
				if (currentPrayer) {
					const text = `${currentPrayer.title}\n\n${currentPrayer.content}`;
					navigator.clipboard.writeText(text).then(() => {
						// Show success feedback
						showToast('Prayer copied to clipboard');
					});
				}
			}

			function showToast(message) {
				// Simple toast implementation
				const toast = document.createElement('div');
				toast.textContent = message;
				toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--text-primary);
                color: var(--bg-primary);
                padding: 12px 20px;
                border-radius: 25px;
                font-weight: 500;
                z-index: 1000;
                animation: fadeInUp 0.3s ease;
            `;

				document.body.appendChild(toast);

				setTimeout(() => {
					toast.remove();
				}, 3000);
			}

			// Initialize history state
			if (!history.state) {
				history.replaceState({ view: 'home' }, '', '/');
			}

			// Handle direct hash navigation
			if (window.location.hash) {
				const slug = window.location.hash.slice(1);
				setTimeout(() => {
					openPrayer(slug);
				}, 1500); // Wait for prayers to load
			}
		</script>
	</body>
</html>
